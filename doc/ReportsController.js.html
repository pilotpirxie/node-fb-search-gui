<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ReportsController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ReportsController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mongoose = require('mongoose');
const databaseConfig = require('../config/database.js');
mongoose.connect(databaseConfig.mongourl);
const Report = require('../models/reports');

/**
 * This controller manages reports
 * @alias ReportsController
 * @constructor
 */
module.exports = {
    /**
     * Create new report
     * @param  {req.body} reportFields Data from form inputs
     * @param  {number} userID ID of relative user
     * @return {object} report Object of report inserted into db or error
     */
    add: function (reportFields, userID) {
        return new Promise((resolve,reject) => {
            let _keywords = reportFields.keywords.split(',');
            _keywords = _keywords.filter(n => n.length > 2);

            let newReportsObj = {
                createDate: (new Date()),
                userID: userID,
                keywords: _keywords.join(','),
                params: {
                    range: reportFields.range,
                    lon: reportFields.coordinates.split(';')[0],
                    lat: reportFields.coordinates.split(';')[1]
                },
                status: false,
                workInProgress: false,
                quotaLimit: 25
            };
            Report.create(newReportsObj).then(report => {
                resolve(report);
            }).catch(err => {
                reject(err);
            });
        });
    },

    /**
     * Get all reports for specific user
     * @param  {string} userID User ID
     * @return {array} Reports
     */
    getAll: function (userID) {
        return new Promise((resolve, reject) => {
            Report.find({userID: userID}).then(reports => {
                var _reports = [];
                for(let report of reports) {
                    let _temp = {
                        id: report._id,
                        createDate: report.createDate.toLocaleString(),
                        keywords: report.keywords.split(','),
                        params: {
                            range: report.params.range,
                            lon: report.params.lon,
                            lat: report.params.lat
                        },
                        status: report.status
                    };
                    _reports.push(_temp);
                }
                resolve(_reports.reverse());
            }).catch(err => {
                reject(err);
            });
        });
    },

    /**
     * Get one specific report
     * @param {string} reportID ID of report to find
     * @param  {number} userID User ID
     * @return {object} Report
     */
    getSingle: function(reportID, userID) {
        return new Promise((resolve, reject) => {
            Report.findOne({userID: userID, _id: reportID}).then(report => {
                report.keywordsArray = report.keywords.split(',');
                report.viewDate = report.createDate.toLocaleString();
                resolve(report);
            }).catch(err => {
                reject(err);
            });
        });
    },

    /**
     * Get unfinished report
     * @return {object} Report
     */
    getQueue: function(report) {
        return new Promise((resolve, reject) => {
            Report.find({status: false}, null, {limit: 3}).sort('createDate').then(reports => {
                resolve(reports);
            }).catch(err => {
                reject(err);
            });
        });
    },

    setStatus: function (reportID, finished) {
        return new Promise ((resolve, reject) => {
            Report.update({_id: reportID}, {status: finished}).then(report => {
                resolve(report);
            }).catch(err => {
                reject(err);
            });
        });
    }

};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="GraphController.html">GraphController</a></li><li><a href="PagesController.html">PagesController</a></li><li><a href="ReportsController.html">ReportsController</a></li><li><a href="UsersController.html">UsersController</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Jun 16 2018 01:17:52 GMT+0200 (Åšrodkowoeuropejski czas letni)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
